# Step 1: Use a Ruby base image since Middleman is Ruby-based
FROM ruby:3.1

# Step 2: Set a working directory in the container
WORKDIR /fashionchecker

# Step 3: Install dependencies required
RUN apt-get update && apt-get install -y \
    build-essential \
    nodejs \
    && rm -rf /var/lib/apt/lists/*

# Step 4: Copy the Gemfile and Gemfile.lock into the container
COPY Gemfile* ./

# Step 5: Install bundler and then the project's dependencies
RUN gem install bundler && bundle install

# Step 6: Copy the rest of your Middleman application into the container
COPY . .

# Step 7: Build the Middleman static site
RUN bundle exec middleman build

# Step 8: Use a lightweight web server like nginx to serve the built site
FROM nginx:latest

# Step 9: Copy the Middleman build output to the nginx html folder
COPY --from=0 /fashionchecker/build /usr/share/nginx/html

# Expose port 80 to access the site
EXPOSE 80

# Start nginx
CMD ["nginx", "-g", "daemon off;"]